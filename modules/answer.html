<!-- ç­”é¢˜é¡µé¢å†…å®¹ -->
<style>
    .question-counter {
        margin-right: 20px;
        font-size: 14px;
    }
    .question-content {
        font-size: 16px;
        line-height: 1.6;
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-left: 4px solid #23915f;
        border-radius: 4px;
    }
    .option-item {
        margin-bottom: 15px;
        padding: 12px;
        background-color: #f8f9fa;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .option-item:hover {
        background-color: #e9ecef;
    }
    .option-item.selected {
        background-color: #23915f;
        color: #fff;
    }
    .option-item.selected:hover {
        background-color: #1e7e4f;
    }
    .option-letter {
        display: inline-block;
        width: 24px;
        height: 24px;
        line-height: 24px;
        text-align: center;
        background-color: #23915f;
        color: #fff;
        border-radius: 50%;
        margin-right: 10px;
        font-weight: bold;
    }
    .option-item.selected .option-letter {
        background-color: #fff;
        color: #23915f;
    }
    .answer-section {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
        display: none;
    }
    .answer-section.show {
        display: block;
    }
    .analysis-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: #23915f;
    }
    .btn-group {
        margin-top: 20px;
        display: flex;
        gap: 10px;
    }
    .result-section {
        text-align: center;
        padding: 20px 10px;
    }
    .result-icon {
        margin-bottom: 20px;
    }
    .result-icon i {
        font-size: 188px;
    }
    .result-title {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 10px;
    }
    .result-score {
        font-size: 48px;
        font-weight: bold;
        margin-bottom: 20px;
        color: #23915f;
    }
    .result-desc {
        margin-bottom: 30px;
        color: #666;
    }
    /* è°ƒæ•´è¯¦ç»†ç»“æœå¡ç‰‡çš„å†…è¾¹è· */
    .layui-card-header {
        padding: 10px 15px;
    }
    .layui-card-body {
        padding: 15px;
    }
    /* å‡å°‘ç»“æœå¡ç‰‡çš„å†…è¾¹è· */
    #result-card {
        padding: 10px;
    }
</style>

<!-- ç­”é¢˜å¡ç‰‡ -->
<div class="card" id="answer-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <div class="card-title">é¢˜ç›®</div>
        <button class="layui-btn layui-btn-danger" id="end-btn">ç»“æŸç­”é¢˜</button>
    </div>
    <div style="text-align: right; margin-bottom: 15px; font-size: 14px; color: #666;">
        ç¬¬ <span id="current-question">1</span>/<span id="total-questions">10</span> é¢˜
    </div>
    <div class="question-content" id="question-content"></div>
    
    <!-- é€‰é¡¹åŒºåŸŸ -->
    <div class="options-container" id="options-container"></div>
    
    <!-- ç­”æ¡ˆå’Œè§£æåŒºåŸŸ -->
    <div class="answer-section" id="answer-section">
        <div class="analysis-title">å‚è€ƒç­”æ¡ˆï¼š</div>
        <div id="correct-answer"></div>
        <div class="analysis-title" style="margin-top: 15px;">è§£æï¼š</div>
        <div id="analysis"></div>
    </div>
    
    <!-- æŒ‰é’®ç»„ - ä½¿ç”¨LayUIæ …æ ¼å¸ƒå±€ï¼Œé€‚é…æ‰€æœ‰å±å¹•å¤§å° -->
    <div class="layui-row layui-col-space5" style="margin-top: 20px;">
        <div class="layui-col-xs4 layui-col-sm4 layui-col-md4">
            <div style="text-align: center;">
                <button class="layui-btn layui-btn-primary" id="prev-btn" style="width: 100%;">ä¸Šä¸€é¢˜</button>
            </div>
        </div>
        <div class="layui-col-xs4 layui-col-sm4 layui-col-md4">
            <div style="text-align: center;">
                <button class="layui-btn layui-btn-primary" id="check-btn" style="width: 100%;">æŸ¥çœ‹ç­”æ¡ˆ</button>
            </div>
        </div>
        <div class="layui-col-xs4 layui-col-sm4 layui-col-md4">
            <div style="text-align: center;">
                <button class="layui-btn layui-btn-normal" id="next-btn" style="width: 100%;">ä¸‹ä¸€é¢˜</button>
            </div>
        </div>
    </div>
</div>

<!-- ç»“æœå¡ç‰‡ -->
<div class="card" id="result-card" style="display: none;">
    <div class="result-section">
        <div class="result-icon" id="result-icon"></div>
        <div class="result-title" id="result-title"></div>
        <div class="result-score" id="result-score"></div>
        <div class="result-desc" id="result-desc"></div>
        <div class="btn-group" style="justify-content: center;">
            <button class="layui-btn layui-btn-normal" id="restart-btn">é‡æ–°ç­”é¢˜</button>
            <button class="layui-btn layui-btn-primary" id="back-home-btn">è¿”å›é¦–é¡µ</button>
        </div>
    </div>
</div>

<script>
    // è®¾ç½®å¯¼èˆªæ ‡é¢˜ä¸º"ç­”é¢˜"
    if (window.HeaderAPI) {
        HeaderAPI.setNavTitle('ç­”é¢˜');
    }
    
    // ç­”é¢˜ç›¸å…³å˜é‡
    var questions = [];
    var originalQuestions = [];
    var currentQuestionIndex = 0;
    var totalQuestions = 0;
    var userAnswers = [];
    var isChecked = false;
    var selectedQuestionCount = 50; // é»˜è®¤ç­”é¢˜æ•°é‡
    
    // åˆå§‹åŒ–ç­”é¢˜
    function initAnswer() {
        // æ˜¾ç¤ºé€‰æ‹©ç­”é¢˜æ•°é‡å¼¹çª—
        showQuestionCountModal();
    }
    
    // æ˜¾ç¤ºé€‰æ‹©ç­”é¢˜æ•°é‡å¼¹çª—
    function showQuestionCountModal() {
        console.log('showQuestionCountModal called, trying to open layer modal...');
        
        try {
            // ç¡®ä¿layerå¯ç”¨
            if (typeof layer === 'undefined') {
                console.error('âŒ layer is not available!');
                return;
            }
            
            console.log('âœ… layer is available, calling layer.open()...');
            
            // æ„å»ºå¼¹çª—å†…å®¹
            var modalContent = '<div style="padding: 20px; width: 420px; overflow: hidden; height: 360px;">' +
                '<div class="layui-form" id="answer-settings-form">' +
                '<div style="display: flex; gap: 5px;">' +
                '<div style="flex: 1;">' +
                '<div class="layui-form-item">' +
                '<label class="layui-form-label">ç­”é¢˜æ•°é‡</label>' +
                '<div class="layui-input-block">' +
                '<input type="number" id="question-count" placeholder="è¯·è¾“å…¥ç­”é¢˜æ•°é‡" class="layui-input" style="width: 80px;" value="50" min="1" max="100">' +
                '</div>' +
                '<div style="margin-top: 10px; color: #666; font-size: 12px;">é»˜è®¤50é¢˜ï¼ŒèŒƒå›´1-100é¢˜</div>' +
                '</div>' +
                '</div>' +
                '<div style="flex: 1;">' +
                '<div class="layui-form-item">' +
                '<label class="layui-form-label">èµ·å§‹é¢˜æ•°</label>' +
                '<div class="layui-input-block">' +
                '<input type="number" id="start-question" placeholder="è¯·è¾“å…¥èµ·å§‹é¢˜æ•°" class="layui-input" style="width: 80px;" value="1" min="1">' +
                '</div>' +
                '<div style="margin-top: 10px; color: #666; font-size: 12px;">ä»ç¬¬Né¢˜å¼€å§‹å‡ºé¢˜ï¼Œé»˜è®¤ä¸º1</div>' +
                '</div>' +
                '</div>' +
                '</div>' +
                
                '<div class="layui-form-item">' +
                '<label class="layui-form-label">é¢˜å‹é€‰æ‹©</label>' +
                '<div class="layui-input-block">' +
                '<input type="checkbox" name="question-types" lay-skin="tag" title="å•é€‰é¢˜" value="1" checked>' +
                '<input type="checkbox" name="question-types" lay-skin="tag" title="å¤šé€‰é¢˜" value="2" checked>' +
                '<input type="checkbox" name="question-types" lay-skin="tag" title="åˆ¤æ–­é¢˜" value="3" checked>' +
                '<input type="checkbox" name="question-types" lay-skin="tag" title="å¡«ç©ºé¢˜" value="4">' +
                '<input type="checkbox" name="question-types" lay-skin="tag" title="ç®€ç­”é¢˜" value="5">' +
                '</div>' +
                '</div>' +
                
                '<div class="layui-form-item">' +
                '<label class="layui-form-label">éšæœºå‡ºé¢˜</label>' +
                '<div class="layui-input-block">' +
                '<input type="checkbox" name="random-questions" id="random-questions" lay-skin="tag" title="éšæœºå‡ºé¢˜">' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</div>';
            
            console.log('ğŸ“‹ Modal content prepared, opening modal...');
            
            // è°ƒç”¨layer.open
            var modalIndex = layer.open({
                type: 1,
                title: 'ç­”é¢˜è®¾ç½®',
                content: modalContent,
                area: ['460px', '400px'],
                success: function(layero, index) {
                    console.log('âœ… Modal opened successfully, index:', index);
                    
                    // æ¸²æŸ“formè¡¨å•ï¼Œç¡®ä¿å¤é€‰æ¡†æ˜¾ç¤ºæ­£ç¡®
                    layui.use('form', function() {
                        console.log('ğŸ“‹ Rendering form...');
                        var form = layui.form;
                        form.render();
                        console.log('âœ… Form rendered successfully');
                    });
                },
                btn: ['å¼€å§‹ç­”é¢˜', 'å–æ¶ˆ'],
                btn1: function(index, layero) {
                    console.log('ğŸ”˜ Start button clicked, index:', index);
                    
                    // è·å–ç”¨æˆ·é€‰æ‹©çš„ç­”é¢˜æ•°é‡
                    var count = parseInt(document.getElementById('question-count').value) || 50;
                    // é™åˆ¶èŒƒå›´1-100
                    count = Math.max(1, Math.min(100, count));
                    selectedQuestionCount = count;
                    console.log('ğŸ“ Selected question count:', count);
                    
                    // è·å–ç”¨æˆ·é€‰æ‹©çš„é¢˜å‹
                    var selectedTypes = [];
                    var formElement = document.getElementById('answer-settings-form');
                    var typeCheckboxes = formElement.querySelectorAll('input[name="question-types"]:checked');
                    for (var i = 0; i < typeCheckboxes.length; i++) {
                        selectedTypes.push(parseInt(typeCheckboxes[i].value));
                    }
                    console.log('ğŸ“ Selected question types:', selectedTypes);
                    
                    // è·å–æ˜¯å¦éšæœºå‡ºé¢˜
                    var isRandomCheckbox = formElement.querySelector('#random-questions');
                    var isRandom = isRandomCheckbox ? isRandomCheckbox.checked : true;
                    console.log('ğŸ² Random questions:', isRandom);
                    
                    // è·å–èµ·å§‹é¢˜æ•°
                    var startQuestion = parseInt(document.getElementById('start-question').value) || 1;
                    startQuestion = Math.max(1, startQuestion);
                    console.log('ğŸ“Œ Start question:', startQuestion);
                    
                    // å¦‚æœæ²¡æœ‰é€‰æ‹©é¢˜å‹ï¼Œé»˜è®¤é€‰æ‹©æ‰€æœ‰é¢˜å‹
                    if (selectedTypes.length === 0) {
                        selectedTypes = [1, 2, 3, 4, 5];
                        console.log('ğŸ“‹ No question types selected, using default:', selectedTypes);
                    }
                    
                    // è·å–é¢˜ç›®åˆ—è¡¨
                    console.log('ğŸ” Calling fetchQuestions()...');
                    fetchQuestions(selectedTypes, isRandom, startQuestion);
                    
                    // å…³é—­å¼¹çª—
                    console.log('ğŸšª Closing modal...');
                    layer.close(index);
                },
                btn2: function(index, layero) {
                    console.log('ğŸ”˜ Cancel button clicked, index:', index);
                    // å–æ¶ˆæŒ‰é’®ï¼šè·³è½¬åˆ°é¦–é¡µ
                    NavAPI.goTo('modules/all-answer.html');
                },
                cancel: function(index) {
                    console.log('âŒ Modal cancelled, index:', index);
                    // ç‚¹å‡»é®ç½©å…³é—­ä¹Ÿè·³è½¬åˆ°é¦–é¡µ
                    NavAPI.goTo('modules/all-answer.html');
                }
            });
            
            console.log('ğŸ”¢ Modal index returned:', modalIndex);
            
        } catch (error) {
            console.error('âŒ Error in showQuestionCountModal:', error);
            // å¦‚æœå¼¹çª—å¤±è´¥ï¼Œç›´æ¥è·å–é¢˜ç›®åˆ—è¡¨ï¼Œè·³è¿‡è®¾ç½®
            console.log('ğŸ”„ Modal failed, using default settings and calling fetchQuestions() directly...');
            fetchQuestions([1, 2, 3], false, 1);
        }
    }
    
    // è·å–é¢˜ç›®åˆ—è¡¨
    function fetchQuestions(selectedTypes = [1, 2, 3, 4, 5], isRandom = false, startQuestion = 1) {
        fetch('api/questions.php')
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    originalQuestions = data.data;
                    
                    // 1. è¿‡æ»¤é¢˜å‹
                    originalQuestions = originalQuestions.filter(question => selectedTypes.includes(question.type));
                    
                    // 2. éšæœºæ’åº
                    if (isRandom) {
                        originalQuestions.sort(() => Math.random() - 0.5);
                    } else {
                        // ééšæœºæ—¶ä¿æŒåŸæœ‰é¡ºåº
                        originalQuestions.sort((a, b) => parseInt(a.id) - parseInt(b.id));
                    }
                    
                    // 3. åº”ç”¨èµ·å§‹é¢˜æ•°
                    let startIndex = startQuestion - 1;
                    startIndex = Math.max(0, Math.min(startIndex, originalQuestions.length - 1));
                    
                    // 4. æˆªå–ç”¨æˆ·é€‰æ‹©çš„ç­”é¢˜æ•°é‡
                    questions = originalQuestions.slice(startIndex, startIndex + selectedQuestionCount);
                    totalQuestions = questions.length;
                    document.getElementById('total-questions').textContent = totalQuestions;
                    
                    // é‡ç½®ç­”é¢˜çŠ¶æ€
                    currentQuestionIndex = 0;
                    userAnswers = [];
                    isChecked = false;
                    
                    // æ˜¾ç¤ºç¬¬ä¸€é¢˜
                    showQuestion(currentQuestionIndex);
                } else {
                    alert('è·å–é¢˜ç›®å¤±è´¥ï¼š' + data.msg);
                }
            })
            .catch(error => {
                console.error('è·å–é¢˜ç›®å¤±è´¥ï¼š', error);
                alert('è·å–é¢˜ç›®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
    }
    
    // æ˜¾ç¤ºé¢˜ç›®
    function showQuestion(index) {
        if (index >= 0 && index < questions.length) {
            currentQuestionIndex = index;
            var question = questions[index];
            
            document.getElementById('current-question').textContent = index + 1;
            document.getElementById('question-content').innerHTML = question.content;
            
            // ç”Ÿæˆé€‰é¡¹
            generateOptions(question);
            
            // é‡ç½®çŠ¶æ€
            isChecked = false;
            document.getElementById('answer-section').classList.remove('show');
            document.getElementById('check-btn').style.display = 'inline-block';
            document.getElementById('next-btn').textContent = index === questions.length - 1 ? 'å®Œæˆ' : 'ä¸‹ä¸€é¢˜';
            
            // å§‹ç»ˆæ˜¾ç¤ºä¸Šä¸€é¢˜æŒ‰é’®ï¼Œåœ¨ç¬¬ä¸€é¢˜æ—¶ç¦ç”¨
            var prevBtn = document.getElementById('prev-btn');
            prevBtn.style.display = 'inline-block';
            prevBtn.disabled = index === 0;
            prevBtn.className = index === 0 ? 'layui-btn layui-btn-primary layui-btn-disabled' : 'layui-btn layui-btn-primary';
        }
    }
    
    // ç”Ÿæˆé€‰é¡¹
    function generateOptions(question) {
        var optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = '';
        
        // åˆ¤æ–­é¢˜
        if (question.type === 3) {
            // ä»æ•°æ®åº“è¯»å–é€‰é¡¹å†…å®¹ï¼Œç”¨ç«–çº¿åˆ†éš”
            var options = question.options ? question.options.split('|') : ['æ­£ç¡®', 'é”™è¯¯'];
            options.forEach((option, index) => {
                var optionItem = document.createElement('div');
                optionItem.className = 'option-item';
                var letter = String.fromCharCode(65 + index);
                optionItem.innerHTML = '<span class="option-letter">' + letter + '</span>' + option;
                optionItem.onclick = function() {
                    selectOption(this, index, question.type);
                };
                optionsContainer.appendChild(optionItem);
            });
        }
        // é€‰æ‹©é¢˜
        else if ([1, 2].includes(question.type)) {
            // ç°åœ¨optionså­—æ®µæ˜¯ç”¨ç«–çº¿åˆ†éš”çš„é€‰é¡¹å†…å®¹
            if (question.options && typeof question.options === 'string') {
                var options = question.options.split('|');
                options.forEach((option, index) => {
                    if (option.trim()) {
                        var optionItem = document.createElement('div');
                        optionItem.className = 'option-item';
                        var letter = String.fromCharCode(65 + index);
                        optionItem.innerHTML = '<span class="option-letter">' + letter + '</span>' + option.trim();
                        optionItem.onclick = function() {
                            selectOption(this, index, question.type);
                        };
                        optionsContainer.appendChild(optionItem);
                    }
                });
            }
        }
        // å¡«ç©ºé¢˜å’Œç®€ç­”é¢˜
        else {
            // æ˜¾ç¤ºç­”æ¡ˆè¾“å…¥æ¡†
            var answerInput = document.createElement('textarea');
            answerInput.id = 'user-answer';
            answerInput.className = 'layui-textarea';
            // å¡«ç©ºé¢˜å’Œç®€ç­”é¢˜ä½¿ç”¨ä¸åŒçš„placeholder
            if (question.type === 4) {
                answerInput.placeholder = 'è¯·è¾“å…¥ç­”æ¡ˆï¼Œä»¥é€—å·åˆ†å‰²';
            } else {
                answerInput.placeholder = 'è¯·è¾“å…¥ç­”æ¡ˆ';
            }
            answerInput.style.marginTop = '20px';
            // ç›‘å¬è¾“å…¥äº‹ä»¶ï¼Œä¿å­˜ç”¨æˆ·ç­”æ¡ˆ
            answerInput.addEventListener('input', function() {
                userAnswers[currentQuestionIndex] = this.value;
            });
            optionsContainer.appendChild(answerInput);
        }
    }
    
    // é€‰æ‹©é€‰é¡¹
    function selectOption(optionElement, optionIndex, questionType) {
        if (questionType === 1) {
            // å•é€‰é¢˜ï¼šåªèƒ½é€‰æ‹©ä¸€ä¸ªé€‰é¡¹
            document.querySelectorAll('.option-item').forEach(item => {
                item.classList.remove('selected');
            });
            optionElement.classList.add('selected');
            // ä¿å­˜ç”¨æˆ·ç­”æ¡ˆ
            userAnswers[currentQuestionIndex] = optionIndex;
        } else if (questionType === 2) {
            // å¤šé€‰é¢˜ï¼šå¯ä»¥é€‰æ‹©å¤šä¸ªé€‰é¡¹
            // åˆ‡æ¢å½“å‰é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
            optionElement.classList.toggle('selected');
            // ä¿å­˜ç”¨æˆ·ç­”æ¡ˆï¼ˆæ•°ç»„å½¢å¼ï¼‰
            var selectedOptions = [];
            document.querySelectorAll('.option-item.selected').forEach(item => {
                var index = Array.from(document.querySelectorAll('.option-item')).indexOf(item);
                selectedOptions.push(index);
            });
            userAnswers[currentQuestionIndex] = selectedOptions;
        } else if (questionType === 3) {
            // åˆ¤æ–­é¢˜ï¼šåªèƒ½é€‰æ‹©ä¸€ä¸ªé€‰é¡¹
            document.querySelectorAll('.option-item').forEach(item => {
                item.classList.remove('selected');
            });
            optionElement.classList.add('selected');
            // ä¿å­˜ç”¨æˆ·ç­”æ¡ˆ
            userAnswers[currentQuestionIndex] = optionIndex;
        }
    }
    
    // æŸ¥çœ‹ç­”æ¡ˆ
    function checkAnswer() {
        if (currentQuestionIndex < questions.length) {
            var question = questions[currentQuestionIndex];
            var answerSection = document.getElementById('answer-section');
            var correctAnswer = document.getElementById('correct-answer');
            var analysis = document.getElementById('analysis');
            
            // æ˜¾ç¤ºç­”æ¡ˆå’Œè§£æ
            if (question.type === 3) {
                // åˆ¤æ–­é¢˜ï¼šæ ¹æ®é€‰é¡¹è·å–ç­”æ¡ˆå†…å®¹
                var options = question.options.split('|');
                var answerLetter = question.answer;
                var answerText = '';
                
                // æ ¹æ®ç­”æ¡ˆå­—æ¯è·å–é€‰é¡¹å†…å®¹
                if (answerLetter === 'A') {
                    answerText = options[0] || 'æ­£ç¡®';
                } else if (answerLetter === 'B') {
                    answerText = options[1] || 'é”™è¯¯';
                } else {
                    answerText = answerLetter;
                }
                correctAnswer.textContent = answerText;
            } else if ([1, 2].includes(question.type)) {
                // é€‰æ‹©é¢˜ï¼šæ ¹æ®ç­”æ¡ˆå­—æ¯è·å–é€‰é¡¹å†…å®¹ï¼Œç«–æ’æ˜¾ç¤º
                var correctAnswerLetters = question.answer;
                var options = question.options.split('|');
                var letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
                var correctOptions = [];
                
                // éå†ç­”æ¡ˆå­—æ¯ï¼Œè·å–å¯¹åº”çš„é€‰é¡¹å†…å®¹
                for (var i = 0; i < correctAnswerLetters.length; i++) {
                    var letter = correctAnswerLetters[i];
                    var index = letters.indexOf(letter);
                    if (index >= 0 && index < options.length) {
                        correctOptions.push(letter + '.' + options[index]);
                    } else {
                        correctOptions.push(letter);
                    }
                }
                // ä½¿ç”¨innerHTMLæ˜¾ç¤ºHTMLæ ‡ç­¾ï¼Œå®ç°ç«–æ’
                correctAnswer.innerHTML = correctOptions.join('<br>');
            } else {
                // å¡«ç©ºé¢˜å’Œç®€ç­”é¢˜
                // å¡«ç©ºé¢˜ç­”æ¡ˆç”¨ç©ºæ ¼åˆ†éš”æ˜¾ç¤º
                var answerText = question.answer;
                if (question.type === 4) {
                    // å¡«ç©ºé¢˜ï¼šå°†ç«–çº¿åˆ†éš”æ”¹ä¸ºç©ºæ ¼åˆ†éš”
                    answerText = answerText.replace(/\|/g, ' ');
                }
                correctAnswer.textContent = answerText;
            }
            analysis.textContent = question.analysis || 'æš‚æ— è§£æ';
            
            answerSection.classList.add('show');
            isChecked = true;
        }
    }
    
    // ä¸‹ä¸€é¢˜
    function nextQuestion() {
        if (currentQuestionIndex >= questions.length - 1) {
            // å®Œæˆç­”é¢˜ï¼Œæ˜¾ç¤ºç»“æœ
            showResult();
        } else {
            showQuestion(currentQuestionIndex + 1);
        }
    }
    
    // ä¸Šä¸€é¢˜
    function prevQuestion() {
        if (currentQuestionIndex > 0) {
            showQuestion(currentQuestionIndex - 1);
        }
    }
    
    // ä¿å­˜é”™é¢˜åˆ°æ•°æ®åº“
    function saveWrongQuestions(wrongQuestions) {
        // å¤„ç†ç”¨æˆ·ç­”æ¡ˆæ ¼å¼
        wrongQuestions.forEach(wrongQuestion => {
            var userAnswer = wrongQuestion.user_answer;
            var questionId = wrongQuestion.question_id;
            
            // æŸ¥æ‰¾å¯¹åº”çš„é¢˜ç›®ï¼Œè·å–é¢˜ç›®ç±»å‹
            var question = questions.find(q => q.id == questionId);
            var questionType = question ? question.type : 0;
            
            // æ ¹æ®é¢˜ç›®ç±»å‹å¤„ç†ç­”æ¡ˆæ ¼å¼
            if (questionType === 1 || questionType === 3) {
                // å•é€‰é¢˜å’Œåˆ¤æ–­é¢˜ï¼šè½¬æ¢ä¸ºå­—æ¯æ ¼å¼ï¼Œå¦‚ 0 -> A, 1 -> B
                if (typeof userAnswer === 'number') {
                    userAnswer = String.fromCharCode(65 + userAnswer);
                } else if (userAnswer === undefined) {
                    userAnswer = '';
                }
            } else if (questionType === 2) {
                // å¤šé€‰é¢˜ï¼šè½¬æ¢ä¸ºå­—æ¯ç»„åˆï¼Œå¦‚ [0, 2] -> AC
                if (Array.isArray(userAnswer)) {
                    // è½¬æ¢ä¸ºå­—æ¯æ•°ç»„
                    var answerLetters = userAnswer.map(index => String.fromCharCode(65 + index));
                    // æ’åºå¹¶æ‹¼æ¥æˆå­—ç¬¦ä¸²
                    userAnswer = answerLetters.sort().join('');
                } else if (userAnswer === undefined) {
                    userAnswer = '';
                }
            } else if (questionType === 4 || questionType === 5) {
                // å¡«ç©ºé¢˜å’Œç®€ç­”é¢˜ï¼šå¤„ç†ç©ºæ ¼
                if (typeof userAnswer === 'string') {
                    // åˆ é™¤å‰åç©ºæ ¼
                    userAnswer = userAnswer.trim();
                    // ä¸­é—´è¿ç»­ç©ºæ ¼æ›¿æ¢ä¸ºä¸€ä¸ª |
                    userAnswer = userAnswer.replace(/\s+/g, '|');
                } else if (userAnswer === undefined) {
                    userAnswer = '';
                }
            }
            
            // æ›´æ–°ç”¨æˆ·ç­”æ¡ˆ
            wrongQuestion.user_answer = userAnswer;
        });
        
        // å‘é€é”™é¢˜ä¿¡æ¯åˆ°åç«¯
        fetch('api/wrong-questions.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(wrongQuestions)
        })
        .then(response => response.json())
        .then(data => {
            if (data.code !== 200 && data.code !== 201) {
                console.error('ä¿å­˜é”™é¢˜å¤±è´¥ï¼š', data.msg);
            }
        })
        .catch(error => {
            console.error('ä¿å­˜é”™é¢˜å¤±è´¥ï¼š', error);
        });
    }
    
    // æ˜¾ç¤ºç»“æœ
    function showResult() {
        // è®¡ç®—å¾—åˆ†å’Œè¯¦ç»†ç»“æœ - åªæ˜¾ç¤ºç”¨æˆ·å·²ç»æµè§ˆè¿‡çš„é¢˜ç›®
        var correctCount = 0;
        var wrongCount = 0;
        var wrongQuestions = [];
        var detailedResults = [];
        
        // åªéå†ç”¨æˆ·å·²ç»æµè§ˆè¿‡çš„é¢˜ç›®ï¼ˆç´¢å¼• <= currentQuestionIndexï¼‰
        var viewedQuestions = questions.slice(0, currentQuestionIndex + 1);
        
        viewedQuestions.forEach((question, index) => {
            var isCorrect = false;
            var userAnswer = userAnswers[index];
            var correctAnswerText = '';
            var userAnswerText = '';
            
            // è·å–é€‰é¡¹å†…å®¹
            var options = [];
            if (question.type === 3) {
                options = question.options ? question.options.split('|') : ['æ­£ç¡®', 'é”™è¯¯'];
            }
            
            // æ ¹æ®é¢˜ç›®ç±»å‹åˆ¤æ–­ç­”æ¡ˆæ˜¯å¦æ­£ç¡®
            if (question.type === 3) {
                // åˆ¤æ–­é¢˜
                // ç­”æ¡ˆæ˜¯å­—æ¯ï¼ˆA/Bï¼‰ï¼Œç”¨æˆ·ç­”æ¡ˆæ˜¯é€‰é¡¹ç´¢å¼•ï¼ˆ0/1ï¼‰
                var correctLetter = question.answer;
                var correctIndex = correctLetter === 'A' ? 0 : 1;
                isCorrect = userAnswer === correctIndex;
                
                // ä¿å­˜é€‰é¡¹å†…å®¹è€Œéå­—æ¯
                correctAnswerText = options[correctIndex] || (correctIndex === 0 ? 'æ­£ç¡®' : 'é”™è¯¯');
                userAnswerText = userAnswer !== undefined ? (options[userAnswer] || (userAnswer === 0 ? 'æ­£ç¡®' : 'é”™è¯¯')) : '';
            } else if (question.type === 1) {
                // å•é€‰é¢˜
                correctAnswerText = question.answer;
                userAnswerText = userAnswer !== undefined ? String.fromCharCode(65 + userAnswer) : '';
                isCorrect = userAnswerText === correctAnswerText;
            } else if (question.type === 2) {
                // å¤šé€‰é¢˜
                correctAnswerText = question.answer;
                // ç”¨æˆ·ç­”æ¡ˆæ–‡æœ¬
                if (Array.isArray(userAnswer)) {
                    userAnswerText = userAnswer.map(index => String.fromCharCode(65 + index)).join('');
                } else {
                    userAnswerText = '';
                }
                // æ¯”è¾ƒç­”æ¡ˆæ˜¯å¦ç›¸åŒï¼ˆå¿½ç•¥é¡ºåºï¼Œè½¬ä¸ºæ•°ç»„æ’åºåæ¯”è¾ƒï¼‰
                var sortedUserAnswer = userAnswerText.split('').sort().join('');
                var sortedCorrectAnswer = correctAnswerText.split('').sort().join('');
                isCorrect = sortedUserAnswer === sortedCorrectAnswer;
            } else {
                // å¡«ç©ºé¢˜å’Œç®€ç­”é¢˜
                var normalizedUserAnswer = userAnswer || '';
                var normalizedCorrectAnswer = question.answer;
                
                if (question.type === 4) {
                    // å¡«ç©ºé¢˜ï¼šå¤„ç†ç­”æ¡ˆæ¯”è¾ƒ
                    // ç»Ÿä¸€å°†æ‰€æœ‰ç­”æ¡ˆè½¬æ¢ä¸ºç©ºæ ¼åˆ†éš”çš„å°å†™æ ¼å¼è¿›è¡Œæ¯”è¾ƒ
                    // æ”¯æŒé€—å·ã€ç«–çº¿ã€ç©ºæ ¼åˆ†éš”çš„ç”¨æˆ·è¾“å…¥
                    normalizedUserAnswer = normalizedUserAnswer.trim().toLowerCase().replace(/[,\|\s]+/g, ' ');
                    normalizedCorrectAnswer = normalizedCorrectAnswer.trim().toLowerCase().replace(/[\|\s]+/g, ' ');
                } else {
                    // ç®€ç­”é¢˜ï¼šç›´æ¥æ¯”è¾ƒ
                    normalizedUserAnswer = normalizedUserAnswer.trim().toLowerCase();
                    normalizedCorrectAnswer = normalizedCorrectAnswer.trim().toLowerCase();
                }
                
                isCorrect = typeof userAnswer === 'string' && 
                           typeof question.answer === 'string' && 
                           normalizedUserAnswer === normalizedCorrectAnswer;
                
                // å¤„ç†å¡«ç©ºé¢˜ç­”æ¡ˆæ˜¾ç¤º
                correctAnswerText = question.answer;
                if (question.type === 4) {
                    // å¡«ç©ºé¢˜ï¼šå°†ç«–çº¿åˆ†éš”æ”¹ä¸ºç©ºæ ¼åˆ†éš”
                    correctAnswerText = correctAnswerText.replace(/\|/g, ' ');
                }
                
                userAnswerText = userAnswer || '';
                // å¡«ç©ºé¢˜ç”¨æˆ·ç­”æ¡ˆä¹Ÿç”¨ç©ºæ ¼åˆ†éš”æ˜¾ç¤º
                if (question.type === 4) {
                    userAnswerText = userAnswerText.replace(/\|/g, ' ');
                }
            }
            
            if (isCorrect) {
                correctCount++;
            } else {
                wrongCount++;
                // è®°å½•é”™é¢˜ä¿¡æ¯
                wrongQuestions.push({
                    user_id: 1, // å‡è®¾å½“å‰ç”¨æˆ·IDä¸º1ï¼Œå®é™…åº”ç”¨ä¸­åº”ä»ç™»å½•çŠ¶æ€è·å–
                    question_id: question.id,
                    user_answer: userAnswer,
                    created_at: new Date().toISOString().slice(0, 19).replace('T', ' ')
                });
            }
            
            // å¤„ç†æœªå¡«å†™ç­”æ¡ˆçš„æƒ…å†µ
            var displayUserAnswerText = userAnswerText;
            if ((question.type === 1 || question.type === 3) && userAnswer === undefined) {
                // å•é€‰é¢˜ã€åˆ¤æ–­é¢˜ï¼šæœªé€‰æ‹©ç­”æ¡ˆ
                displayUserAnswerText = '<span style="color: #ff5722;">æœªå¡«å†™</span>';
            } else if (question.type === 2 && (!userAnswer || userAnswer.length === 0)) {
                // å¤šé€‰é¢˜ï¼šæœªé€‰æ‹©ç­”æ¡ˆ
                displayUserAnswerText = '<span style="color: #ff5722;">æœªå¡«å†™</span>';
            } else if ((question.type === 4 || question.type === 5) && (!userAnswer || userAnswer.trim() === '')) {
                // å¡«ç©ºé¢˜ã€ç®€ç­”é¢˜ï¼šæœªå¡«å†™ç­”æ¡ˆ
                displayUserAnswerText = '<span style="color: #ff5722;">æœªå¡«å†™</span>';
            } else if (question.type === 4) {
                // å¡«ç©ºé¢˜ï¼šç”¨æˆ·è¾“å…¥çš„æ˜¯é€—å·åˆ†éš”ï¼Œæ˜¾ç¤ºä¸ºç©ºæ ¼åˆ†éš”
                displayUserAnswerText = displayUserAnswerText.replace(/[,\|]+/g, ' ');
            }
            
            // ä¿å­˜è¯¦ç»†ç»“æœ
            detailedResults.push({
                question: question,
                userAnswer: userAnswer,
                userAnswerText: displayUserAnswerText,
                correctAnswerText: correctAnswerText,
                isCorrect: isCorrect
            });
        });
        
        var totalViewedQuestions = detailedResults.length;
        var score = totalViewedQuestions > 0 ? Math.round((correctCount / totalViewedQuestions) * 100) : 0;
        
        // ä¿å­˜é”™é¢˜åˆ°æ•°æ®åº“
        if (wrongQuestions.length > 0) {
            saveWrongQuestions(wrongQuestions);
        }
        
        // æ˜¾ç¤ºç»“æœ
        document.getElementById('answer-card').style.display = 'none';
        document.getElementById('result-card').style.display = 'block';
        
        // ç”Ÿæˆç»“æœHTML
        var resultHTML = generateResultHTML(correctCount, wrongCount, detailedResults, totalViewedQuestions);
        document.getElementById('result-card').innerHTML = resultHTML;
        
        // é‡æ–°ç»‘å®šæŒ‰é’®äº‹ä»¶
        document.getElementById('restart-btn').onclick = restart;
        document.getElementById('back-home-btn').onclick = function() {
            NavAPI.goTo('modules/all-answer.html');
        };
    }
    
    // ç”Ÿæˆç»“æœHTML
    function generateResultHTML(correctCount, wrongCount, detailedResults, totalViewedQuestions) {
        // ä½¿ç”¨ä¼ å…¥çš„totalViewedQuestionså‚æ•°è®¡ç®—åˆ†æ•°
        var score = totalViewedQuestions > 0 ? Math.round((correctCount / totalViewedQuestions) * 100) : 0;
        
        // ç»“æœæ ‡é¢˜å’Œå›¾æ ‡
        var resultIcon = '<i class="layui-icon layui-icon-face-smile" style="color: #23915f;"></i>';
        var resultTitle = 'æ­å–œä½ ï¼Œè€ƒè¯•é€šè¿‡ï¼';
        var resultDesc = 'ä½ çš„è¡¨ç°éå¸¸ä¼˜ç§€ï¼Œç»§ç»­ä¿æŒï¼';
        
        if (score < 60) {
            resultIcon = '<i class="layui-icon layui-icon-face-cry" style="color: #ff5722;"></i>';
            resultTitle = 'å¾ˆé—æ†¾ï¼Œè€ƒè¯•æœªé€šè¿‡';
            resultDesc = 'åˆ«ç°å¿ƒï¼Œç»§ç»­åŠªåŠ›ï¼Œä¸‹æ¬¡ä¸€å®šèƒ½é€šè¿‡ï¼';
        } else if (score < 90) {
            resultIcon = '<i class="layui-icon layui-icon-face-smile"></i>';
            resultTitle = 'æ­å–œä½ ï¼Œè€ƒè¯•é€šè¿‡ï¼';
            resultDesc = 'ç»§ç»­åŠªåŠ›ï¼Œäº‰å–æ›´å¥½çš„æˆç»©ï¼';
        }
        
        // ç”Ÿæˆè¯¦ç»†ç»“æœåˆ—è¡¨ - åªæ˜¾ç¤ºç”¨æˆ·å·²ç»æµè§ˆè¿‡çš„é¢˜ç›®
        var resultsList = '';
        detailedResults.forEach((result, index) => {
            var question = result.question;
            var userAnswer = result.userAnswer;
            var statusClass = result.isCorrect ? 'correct' : 'wrong';
            var statusText = result.isCorrect ? 'æ­£ç¡®' : 'é”™è¯¯';
            var statusColor = result.isCorrect ? '#23915f' : '#ff5722';
            
            // ç”Ÿæˆé€‰é¡¹åˆ—è¡¨
            var optionsList = '';
            if (question.type === 3) {
                // åˆ¤æ–­é¢˜
                var options = question.options ? question.options.split('|') : ['æ­£ç¡®', 'é”™è¯¯'];
                options.forEach((option, optIndex) => {
                    var letter = String.fromCharCode(65 + optIndex);
                    var color = '';
                    
                    // åˆ¤æ–­æ˜¯å¦ä¸ºæ­£ç¡®ç­”æ¡ˆ
                    var isCorrectOption = question.answer === letter;
                    // åˆ¤æ–­æ˜¯å¦ä¸ºç”¨æˆ·ç­”æ¡ˆ
                    var isUserOption = userAnswer === optIndex;
                    
                    if (isCorrectOption) {
                        color = '#23915f'; // æ­£ç¡®ç­”æ¡ˆæ ‡ç»¿
                    } else if (isUserOption && !result.isCorrect) {
                        color = '#ff5722'; // ç”¨æˆ·é”™è¯¯ç­”æ¡ˆæ ‡çº¢
                    }
                    
                    if (color) {
                        optionsList += '<span style="color: ' + color + ';">' + letter + 'ï¼š' + option + '</span><br>';
                    } else {
                        optionsList += letter + 'ï¼š' + option + '<br>';
                    }
                });
            } else if ([1, 2].includes(question.type)) {
                // é€‰æ‹©é¢˜
                var options = question.options.split('|');
                var letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
                
                options.forEach((option, optIndex) => {
                    if (option.trim()) {
                        var letter = letters[optIndex];
                        var color = '';
                        
                        // åˆ¤æ–­æ˜¯å¦ä¸ºæ­£ç¡®ç­”æ¡ˆ
                        var isCorrectOption = question.answer.includes(letter);
                        // åˆ¤æ–­æ˜¯å¦ä¸ºç”¨æˆ·ç­”æ¡ˆ
                        var isUserOption = false;
                        if (Array.isArray(userAnswer)) {
                            // å¤šé€‰é¢˜
                            isUserOption = userAnswer.includes(optIndex);
                        } else {
                            // å•é€‰é¢˜
                            isUserOption = userAnswer === optIndex;
                        }
                        
                        if (isCorrectOption) {
                            color = '#23915f'; // æ­£ç¡®ç­”æ¡ˆæ ‡ç»¿
                        } else if (isUserOption && !result.isCorrect) {
                            color = '#ff5722'; // ç”¨æˆ·é”™è¯¯ç­”æ¡ˆæ ‡çº¢
                        }
                        
                        if (color) {
                            optionsList += '<span style="color: ' + color + ';">' + letter + 'ï¼š' + option.trim() + '</span><br>';
                        } else {
                            optionsList += letter + 'ï¼š' + option.trim() + '<br>';
                        }
                    }
                });
            }
            
            resultsList += '<div class="layui-card" style="margin-bottom: 10px;">' +
                '<div class="layui-card-header" style="display: flex; justify-content: space-between; align-items: center;">' +
                '<span>ç¬¬' + (index + 1) + 'é¢˜</span>' +
                '<span style="color: ' + statusColor + '; font-weight: bold;">' + statusText + '</span>' +
                '</div>' +
                '<div class="layui-card-body">' +
                '<div style="margin-bottom: 10px;">' +
                '<strong>é¢˜ç›®ï¼š</strong>' + question.content +
                '</div>' +
                (optionsList ? '<div style="margin-bottom: 10px; text-align: left;">' +
                '<strong>é€‰é¡¹ï¼š</strong><br><div style="margin-left: 20px;">' + optionsList + '</div>' +
                '</div>' : '') +
                '<div style="margin-bottom: 10px;">' +
                '<strong>ä½ çš„ç­”æ¡ˆï¼š</strong>' + (result.isCorrect ? result.userAnswerText : '<span style="color: #ff5722;">' + result.userAnswerText + '</span>') +
                '</div>' +
                '<div style="margin-bottom: 10px;">' +
                '<strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong><span style="color: #23915f;"> ' + result.correctAnswerText + '</span>' +
                '</div>' +
                '<div style="margin-bottom: 10px;">' +
                '<strong>è§£æï¼š</strong>' + (question.analysis || 'æš‚æ— è§£æ') +
                '</div>' +
                '</div>' +
                '</div>';
        });
        
        // å®Œæ•´çš„ç»“æœHTML
        var html = '<div class="result-section">' +
            '<div class="result-icon">' + resultIcon + '</div>' +
            '<div class="result-title">' + resultTitle + '</div>' +
            '<div class="result-score">' + score + 'åˆ†</div>' +
            '<div class="result-desc">' + resultDesc + '</div>' +
            '<div class="layui-card" style="margin-bottom: 20px;">' +
            '<div class="layui-card-header">ç­”é¢˜ç»Ÿè®¡</div>' +
            '<div class="layui-card-body" style="display: flex; justify-content: space-around;">' +
            '<div style="text-align: center;">' +
            '<div style="font-size: 24px; font-weight: bold; color: #23915f;">' + correctCount + '</div>' +
            '<div style="color: #666;">ç­”å¯¹é¢˜æ•°</div>' +
            '</div>' +
            '<div style="text-align: center;">' +
            '<div style="font-size: 24px; font-weight: bold; color: #ff5722;">' + wrongCount + '</div>' +
            '<div style="color: #666;">ç­”é”™é¢˜æ•°</div>' +
            '</div>' +
            '<div style="text-align: center;">' +
            '<div style="font-size: 24px; font-weight: bold; color: #333;">' + totalViewedQuestions + '</div>' +
            '<div style="color: #666;">å·²ç­”é¢˜æ•°</div>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '<div class="btn-group" style="justify-content: center; margin-bottom: 30px;">' +
            '<button class="layui-btn layui-btn-normal" id="restart-btn">é‡æ–°ç­”é¢˜</button>' +
            '<button class="layui-btn layui-btn-primary" id="back-home-btn">è¿”å›é¦–é¡µ</button>' +
            '</div>' +
            '<div class="layui-card">' +
            '<div class="layui-card-header">è¯¦ç»†ç»“æœ</div>' +
            '<div class="layui-card-body">' +
            resultsList +
            '</div>' +
            '</div>' +
            '</div>';
        
        return html;
    }
    
    // é‡æ–°ç­”é¢˜
    function restart() {
        document.getElementById('result-card').style.display = 'none';
        document.getElementById('answer-card').style.display = 'block';
        currentQuestionIndex = 0;
        userAnswers = [];
        initAnswer();
    }
    
    // ç»“æŸç­”é¢˜
    function endAnswer() {
        layer.confirm('ç¡®å®šè¦ç»“æŸç­”é¢˜å—ï¼Ÿ', {
            btn: ['ç¡®å®š', 'å–æ¶ˆ']
        }, function(index) {
            // å…³é—­ç¡®è®¤æ¡†
            layer.close(index);
            // æ˜¾ç¤ºç»“æœ
            showResult();
        });
    }
    
    // ç®€åŒ–çš„åˆå§‹åŒ–å‡½æ•°ï¼Œä¼˜å…ˆæ˜¾ç¤ºç­”é¢˜è®¾ç½®å¼¹æ¡†
    function initializeAnswer() {
        console.log('=== Initializing Answer Module ===');
        
        // æ£€æŸ¥layuiæ˜¯å¦å¯ç”¨
        if (typeof layui === 'undefined') {
            console.error('âŒ Layui is not available! Cannot initialize answer function.');
            return;
        }
        
        console.log('âœ… Layui is available. Loading layer module first for settings modal...');
        
        // ä¼˜å…ˆåŠ è½½layeræ¨¡å—ï¼Œç«‹å³æ˜¾ç¤ºç­”é¢˜è®¾ç½®æ¡†
        layui.use('layer', function() {
            console.log('âœ… Layer module loaded, showing settings modal immediately...');
            
            // ä¸éœ€è¦ç­‰å¾…DOMå®Œå…¨åŠ è½½ï¼Œç›´æ¥æ˜¾ç¤ºç­”é¢˜è®¾ç½®æ¡†
            initAnswer();
            
            // ç„¶åå†åŠ è½½formæ¨¡å—å¹¶ç»‘å®šäº‹ä»¶
            console.log('ğŸ”„ Loading form module and binding events...');
            layui.use('form', function() {
                console.log('âœ… Form module loaded');
                
                // ç»‘å®šæŒ‰é’®äº‹ä»¶
                setTimeout(function() {
                    console.log('ğŸ”— Binding button events...');
                    var checkBtn = document.getElementById('check-btn');
                    var nextBtn = document.getElementById('next-btn');
                    var prevBtn = document.getElementById('prev-btn');
                    var endBtn = document.getElementById('end-btn');
                    
                    if (checkBtn) {
                        checkBtn.onclick = checkAnswer;
                        console.log('âœ… Check button event bound');
                    }
                    if (nextBtn) {
                        nextBtn.onclick = nextQuestion;
                        console.log('âœ… Next button event bound');
                    }
                    if (prevBtn) {
                        prevBtn.onclick = prevQuestion;
                        console.log('âœ… Prev button event bound');
                    }
                    if (endBtn) {
                        endBtn.onclick = endAnswer;
                        console.log('âœ… End button event bound');
                    }
                }, 100);
            });
        });
    }
    
    // ç›´æ¥è°ƒç”¨åˆå§‹åŒ–ï¼Œåªæ‰§è¡Œä¸€æ¬¡
    console.log('ğŸ“¢ Starting answer module initialization...');
    initializeAnswer();
    
    // ç§»é™¤é‡å¤çš„åˆå§‹åŒ–è°ƒç”¨ï¼Œé¿å…å¼¹çª—å¼¹å‡ºä¸¤æ¬¡
    // åªæ‰§è¡Œä¸€æ¬¡åˆå§‹åŒ–ï¼Œç¡®ä¿å¼¹çª—åªæ˜¾ç¤ºä¸€æ¬¡
</script>